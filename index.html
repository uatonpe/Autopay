<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Mandate Monitoring Dashboard</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body { font-family: 'Roboto', sans-serif; background-color: #f0f2f5; color: #333; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .header { background-color: #004a7c; color: white; padding: 15px 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .header h1 { margin: 0; font-size: 1.5rem; }
        .filter-container { background-color: #ffffff; padding: 15px 30px; border-bottom: 1px solid #e0e0e0; display: flex; flex-wrap: wrap; align-items: center; gap: 20px; }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-container label { font-weight: 500; color: #555; }
        .filter-container select, .filter-container input[type="text"] { padding: 8px 12px; border-radius: 5px; border: 1px solid #ccc; font-size: 0.9rem; }
        #search-input { width: 220px; }
        #search-btn { padding: 9px 15px; border: none; background-color: #007bff; color: white; border-radius: 5px; cursor: pointer; font-size: 0.9rem; }
        .dashboard-container { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .kpi-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .kpi-card { background-color: #ffffff; padding: 20px; border-radius: 8px; border: 2px solid transparent; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); cursor: pointer; transition: all 0.2s; }
        .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08); }
        .kpi-card.active { border-color: #007bff; }
        .kpi-card h2 { margin: 0 0 10px 0; font-size: 1rem; color: #555; font-weight: 500; }
        .kpi-card .value { margin: 0; font-size: 2.2rem; font-weight: 700; color: #004a7c; }
        .kpi-card.success .value { color: #28a745; }
        .kpi-card.failed .value { color: #dc3545; }
        .widget { background-color: #ffffff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); }
        .widget-header h3 { margin: 0; font-size: 1.2rem; color: #333; }
        .table-wrapper { max-height: 500px; overflow-y: auto; }
        #data-table { width: 100%; border-collapse: collapse; }
        #data-table th, #data-table td { padding: 12px 15px; text-align: left; white-space: nowrap; }
        #data-table th { background-color: #f8f9fa; font-weight: 500; position: sticky; top: 0; }
        #data-table tbody tr { border-bottom: 1px solid #f0f0f0; }
        .status-pill { padding: 5px 12px; border-radius: 15px; color: white; font-size: 0.8rem; font-weight: 500; text-transform: capitalize; }
        .status-pill.collection_success, .status-pill.completed, .status-pill.active { background-color: #28a745; }
        .status-pill.collection_failed, .status-pill.expired, .status-pill.cancelled { background-color: #dc3545; }
        .status-pill.created, .status-pill.scheduled, .status-pill.pending { background-color: #ffc107; color: #333; }
    </style>
</head>
<body>
    <header class="header"><h1>Interactive Mandate Dashboard</h1></header>
    <div class="filter-container">
        <div class="filter-group">
            <label for="unit-filter">Unit:</label>
            <select id="unit-filter">
                <option value="ALL">All Units</option>
                <option value="+918007773888">Kallam</option>
                <option value="+918554002642">Washi</option>
                <option value="+919823775999">Bhoom</option>
                <option value="+919923267111">Beed</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="date-filter">Date:</label>
            <select id="date-filter">
                <option value="this_month" selected>This Month</option>
                <option value="last_month">Last Month</option>
                <option value="today">Today</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="status-filter">Status:</label>
            <select id="status-filter">
                <option value="ALL">All Statuses</option>
                <option value="collection_success">Success</option>
                <option value="collection_failed">Failed</option>
                <option value="pending">Pending</option>
                <option value="active">Active</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="search-input">Search:</label>
            <input type="text" id="search-input" placeholder="Name, Mobile, or Loan No...">
            <button id="search-btn">Search</button>
        </div>
    </div>
    <main class="dashboard-container">
        <div class="kpi-container">
            <div class="kpi-card success" data-kpi="success"><h2>Total Collection</h2><p class="value" id="kpi-total-collection">₹ 0</p></div>
            <div class="kpi-card" data-kpi="upcoming"><h2>Upcoming Collection</h2><p class="value" id="kpi-upcoming-collection">₹ 0</p></div>
            <div class="kpi-card failed" data-kpi="failed"><h2>Failed Collection</h2><p class="value" id="kpi-failed-collection">₹ 0</p></div>
            <div class="kpi-card" data-kpi="mandates"><h2>Total Mandates</h2><p class="value" id="kpi-total-mandates">0</p></div>
        </div>
        <div class="widget">
            <div class="widget-header"><h3>Mandate & Installment Details</h3></div>
            <div class="table-wrapper">
                <table id="data-table">
                    <thead><tr><th>Due Date</th><th>Customer Name</th><th>Mobile</th><th>Loan Number</th><th>Amount</th><th>Status</th><th>Unit</th></tr></thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </main>
    <script>
        const TOKENS = {
            "+918007773888": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbnRlcnByaXNlX2lkIjoiMjcyYzVmOGMtZWQ1OC00MTg2LWEwMWQtY2JiMGJmMTFjOTg2IiwiZW50ZXJwcmlzZV9hY2NvdW50X2tleSI6InVFQWREWnFSQSIsImVudGVycHJpc2VfYWNjb3VudF9zZWNyZXQiOiI4amVGWUZjQ0I2WlFIY2tyN1FCajhSZ0QwOCtxMWtadUxOZUxML01ISU9EZmkyOWZjRGpUbzlPZENCZVNyS3pVaGpmSmRtTnN0eFo2aTZFZFRRcFdRN2NDRHo3ZkpBaVVIQ2dlL0hMRHJteGYrRVFLMmRUZGVudzNod1FlVjhGS0pmR3JOMGZYbGowZFFFMHZMRWl2OUFLVjdrclREV3VvR3d6S3VGZGlpK3E4VWtMRlJaWVU2TFhIaXpTaGdDNjYiLCJpZCI6IjAwMDAwMTk5LTg1YmItOTEzNi04NTJkLTA0MDBmNDM5OGY"
        };
        let processedData = [];

        const formatCurrency = (amount) => `₹ ${amount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
        const formatDate = (epoch) => epoch ? new Date(epoch).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' }) : 'N/A';
        function getUnitNameFromMobile(mobile) {
            if (mobile === '+918007773888') return 'Kallam';
            if (mobile === '+918554002642') return 'Washi';
            if (mobile === '+919823775999') return 'Bhoom';
            if (mobile === '+919923267111') return 'Beed';
            return 'Unknown';
        }

        async function loadInitialData() {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Loading data from server...</td></tr>';
            
            const syncMandatesApiUrl = 'https://api-staging.rocketpay.co.in/v1/merchant/mandates/sync';
            const selectedUnit = document.getElementById('unit-filter').value;
            const unitsToFetch = selectedUnit === 'ALL' ? Object.keys(TOKENS) : [selectedUnit];
            let allMandatesData = [];

            try {
                for (const unitMobile of unitsToFetch) {
                    const apiToken = TOKENS[unitMobile];
                    let next_updated_at = 0;
                    let next_created_at = 0;
                    let hasMore = true;

                    while (hasMore) {
                        const url = `${syncMandatesApiUrl}?updated_at=${next_updated_at}&limit=100&created_at=${next_created_at}`;
                        const response = await fetch(url, { headers: { 'x-token': apiToken } });
                        if (!response.ok) throw new Error(`API request failed for unit ${unitMobile}`);
                        
                        const result = await response.json();
                        const mandatesOnPage = result.items || [];
                        
                        // NOTE: The Sync API returns mandate data, not installments.
                        // We will treat each mandate as a single row in the table.
                        mandatesOnPage.forEach(mandate => {
                            allMandatesData.push({
                                mandateId: mandate.id,
                                loanNumber: mandate.reference_id || 'N/A',
                                customerName: mandate.customer.name,
                                customerMobile: mandate.customer.mobile_number,
                                unitMobile: mandate.merchant_info.mobile_number,
                                unitName: getUnitNameFromMobile(mandate.merchant_info.mobile_number),
                                installmentAmount: mandate.amount, // Total mandate amount
                                dueDate: mandate.next_charge_at, // Use next_charge_at for date filtering
                                status: mandate.state // Use mandate state
                            });
                        });
                        
                        if (result.returned < 100 || mandatesOnPage.length === 0) {
                            hasMore = false;
                        } else {
                            const lastItem = mandatesOnPage[mandatesOnPage.length - 1];
                            next_updated_at = lastItem.updated_at;
                            next_created_at = lastItem.created_at;
                        }
                    }
                }
                processedData = allMandatesData;
                renderDashboard();
            } catch (error) {
                console.error("Error fetching live data:", error);
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Failed to load data. Check CORS policy and console for errors.</td></tr>';
            }
        }

        function renderDashboard() {
            const unitFilter = document.getElementById('unit-filter').value;
            const dateFilter = document.getElementById('date-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();

            let baseFilteredData = processedData;
            if (unitFilter !== 'ALL') baseFilteredData = baseFilteredData.filter(item => item.unitMobile === unitFilter);

            const now = new Date();
            if (dateFilter === 'today') baseFilteredData = baseFilteredData.filter(item => item.dueDate && new Date(item.dueDate).toDateString() === now.toDateString());
            else if (dateFilter === 'this_month') baseFilteredData = baseFilteredData.filter(item => item.dueDate && new Date(item.dueDate).getMonth() === now.getMonth() && new Date(item.dueDate).getFullYear() === now.getFullYear());
            else if (dateFilter === 'last_month') {
                const lastMonth = now.getMonth() === 0 ? 11 : now.getMonth() - 1;
                const year = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
                baseFilteredData = baseFilteredData.filter(item => item.dueDate && new Date(item.dueDate).getMonth() === lastMonth && new Date(item.dueDate).getFullYear() === year);
            }
            
            updateKPIs(baseFilteredData, unitFilter);

            let tableData = baseFilteredData;
            if (statusFilter !== 'ALL') tableData = tableData.filter(item => item.status === statusFilter);

            if (searchTerm) {
                tableData = tableData.filter(item => 
                    item.customerName.toLowerCase().includes(searchTerm) ||
                    item.customerMobile.includes(searchTerm) ||
                    item.loanNumber.toLowerCase().includes(searchTerm)
                );
            }
            updateTable(tableData);
        }
        
        function updateKPIs(data, unitFilter) {
            // Simplified KPI logic based on mandate state
            let total = data.reduce((s, i) => (i.status === 'completed' || i.status === 'active') ? s + i.installmentAmount : s, 0);
            let upcoming = data.reduce((s, i) => (i.status === 'pending' || i.status === 'accepted') ? s + i.installmentAmount : s, 0);
            let failed = data.reduce((s, i) => (i.status === 'expired' || i.status === 'cancelled') ? s + i.installmentAmount : s, 0);
            const mandatesInUnit = (unitFilter === 'ALL') ? processedData : processedData.filter(i => i.unitMobile === unitFilter);
            const totalMandates = new Set(mandatesInUnit.map(i => i.mandateId)).size;

            document.getElementById('kpi-total-collection').textContent = formatCurrency(total);
            document.getElementById('kpi-upcoming-collection').textContent = formatCurrency(upcoming);
            document.getElementById('kpi-failed-collection').textContent = formatCurrency(failed);
            document.getElementById('kpi-total-mandates').textContent = totalMandates;
        }

        function updateTable(data) {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = ''; 
            if (data.length === 0) { tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No data found for the selected criteria.</td></tr>'; return; }
            data.sort((a, b) => (b.dueDate || 0) - (a.dueDate || 0)); 
            data.forEach(item => {
                tableBody.innerHTML += `<tr><td>${formatDate(item.dueDate)}</td><td>${item.customerName}</td><td>${item.customerMobile}</td><td>${item.loanNumber}</td><td>${formatCurrency(item.installmentAmount)}</td><td><span class="status-pill ${item.status}">${item.status.replace('_', ' ')}</span></td><td>${item.unitName}</td></tr>`;
            });
        }
        
        function removeActiveCardState() { document.querySelectorAll('.kpi-card').forEach(c => c.classList.remove('active')); }

        document.getElementById('unit-filter').addEventListener('change', () => { removeActiveCardState(); loadInitialData(); });
        document.querySelectorAll('#date-filter, #status-filter').forEach(el => el.addEventListener('change', () => { removeActiveCardState(); renderDashboard(); }));
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        searchBtn.addEventListener('click', renderDashboard);
        searchInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') renderDashboard(); });

        document.querySelectorAll('.kpi-card').forEach(card => {
            card.addEventListener('click', () => {
                removeActiveCardState(); card.classList.add('active');
                const kpiType = card.dataset.kpi;
                const statusFilter = document.getElementById('status-filter');
                if (kpiType === 'success') statusFilter.value = 'active';
                else if (kpiType === 'failed') statusFilter.value = 'collection_failed'; // Or other failed states
                else if (kpiType === 'upcoming') statusFilter.value = 'pending';
                else if (kpiType === 'mandates') statusFilter.value = 'ALL';
                renderDashboard();
            });
        });

        window.addEventListener('load', () => { document.getElementById('unit-filter').value = 'ALL'; loadInitialData(); });
    </script>
</body>
</html>
